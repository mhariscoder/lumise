jQuery(document).ready((function(t){t("#woocommerce-product-data ul.wc-tabs li.lumise_tab a").trigger("click");var e=function(t){var e;for(var i in t.events){if("function"==typeof t.events[i])e=t.events[i];else{if("function"!=typeof t[t.events[i]])continue;e=t[t.events[i]]}(i=i.split(",")).map((function(i){void 0===(i=i.split(":"))[1]&&(i[1]="click"),""===i[0]?t.el.off(i[1]).on(i[1],t,e):t.el.find(i[0]).off(i[1]).on(i[1],t,e)}))}},i=function(e){if("close"==e)return t("body").css({overflow:""}),t("#lumise-lightbox").remove();var i='<div id="lumise-lightbox" class="lumise-lightbox">\t\t\t\t\t\t\t<div id="lumise-lightbox-body">\t\t\t\t\t\t\t\t<div id="lumise-lightbox-content" class="%class%" style="min-width:%width%px">\t\t\t\t\t\t\t\t\t%content%\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t%footer%\t\t\t\t\t\t\t\t<a class="kalb-close" href="#close" title="Close">\t\t\t\t\t\t\t\t\t<i class="dashicons dashicons-no-alt"></i>\t\t\t\t\t\t\t\t</a>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t<div class="kalb-overlay"></div>\t\t\t\t\t\t</div>',s=t.extend({width:1e3,class:"",footer:"",content:"",onload:function(){},onclose:function(){}},e);""!==s.footer&&(s.footer='<div id="lumise-lightbox-footer">'+s.footer+"</div>"),i=t(i.replace(/\%width\%/g,s.width).replace(/\%class\%/g,s.class).replace(/\%content\%/g,s.content).replace(/\%footer\%/g,s.footer)),t(".lumise-lightbox").remove(),t("body").append(i).css({overflow:"hidden"}),s.onload(i),i.find("a.kalb-close,div.kalb-overlay").on("click",(function(e){s.onclose(i),t(".lumise-lightbox").remove(),t("body").css({overflow:""}),e.preventDefault()}))},s=function(i){var s=['<ul data-view="categories">',"<h3>"+lumisejs._i56+"</h3>",'<li data-id="all" class="active" data-lv="0"> '+lumisejs._i57+"</li>"],a=['<h3 data-view="top">'+lumisejs._i62+' <a href="#new-product"><i class="dashicons dashicons-plus"></i> '+lumisejs._i59+'</a> <input type="search" placeholder="'+lumisejs._i63+'" /></h3>','<ul data-view="items">'];i.categories&&i.categories.map((function(t){s.push('<li data-id="'+t.id+'" data-lv="'+t.lv+'">'+"&mdash;".repeat(t.lv)+" "+t.name+"</li>")})),i.products&&i.products.length>0?i.products.map((function(e){var i=JSON.parse(decodeURIComponent(atob(e.stages))),s=i["colors"!==Object.keys(i)[0]?Object.keys(i)[0]:Object.keys(i)[1]],l=t("#lumise_product_base").val(),d="",n="",o=void 0!==i.colors?i.colors.active:e.color.split(":")[0];e.cates&&((n=e.cates.split(",")).map((function(t,e){n[e]="cate-"+t})),n=' class="'+n.join(" ")+'"'),d="raws"==s.source?lumisejs.assets_url+"raws/"+s.url:lumisejs.upload_url+s.url,a.push('<li data-id="'+e.id+'"'+n+(l==e.id?' data-current="true"':"")+' data-name="'+e.name.toLowerCase().trim().replace(/[^a-z0-9 ]/gim,"")+'">\t\t\t\t\t\t\t<span data-view="thumbn" data-start="'+lumisejs._i64+'">\t\t\t\t\t\t\t\t<img style="background:'+o+'" src="'+d+'" />\t\t\t\t\t\t\t</span>\t\t\t\t\t\t\t<span data-view="name">'+e.name+"</span>\t\t\t\t\t\t</li>")})):a.push('<li data-view="noitem">'+lumisejs._i42+"</li>"),t("#lumise-lightbox-content").html('<div id="lumise-list-items-wrp"></div>'),t("#lumise-list-items-wrp").html(s.join("")).append(a.join("")),e({el:t("#lumise-list-items-wrp"),events:{'ul[data-view="categories"] li':"category",'ul[data-view="items"] li':"product",'h3[data-view="top"] input:input':"search",'h3[data-view="top"] a[href="#new-product"]':"new_product"},category:function(){var e=t(this).closest("#lumise-list-items-wrp"),i=this.getAttribute("data-id");e.find('ul[data-view="categories"] li.active').removeClass("active"),t(this).addClass("active"),"all"==i?e.find('ul[data-view="items"] li').show():(e.find('ul[data-view="items"] li').hide(),e.find('ul[data-view="items"] li.cate-'+i).show())},product:function(e){var i=this.getAttribute("data-id"),s=u.products.products.filter((function(t){return t.id==i}));t(this).closest("#lumise-lightbox").remove(),t("body").css({overflow:""}),t("#lumise_product_base").val(s[0].id),l(s[0]),u.current_product=s[0].id},new_product:function(e){t("#lumise-lightbox-content").addClass("full-screen").html('<iframe src="'+lumisejs.admin_url+'&lumise-page=product&callback=edit-cms-product"></iframe>')},search:function(t){t.data.el.find('ul[data-view="categories"] li.active').removeClass("active"),t.data.el.find('ul[data-view="categories"] li[data-id="all"]').addClass("active");var e=this.value.toLowerCase();t.data.el.find('ul[data-view="items"] li[data-id]').each((function(){""===e||this.getAttribute("data-name").indexOf(e)>-1?this.style.display="list-item":this.style.display="none"}))}})},a=function(i){var s=['<ul data-view="categories">',"<h3>"+lumisejs._i56+"</h3>",'<li data-id="" '+(""===i.category?'class="active"':"")+' data-lv="0"> '+lumisejs._i57+"</li>"],a=['<h3 data-view="top">'+lumisejs._i66+'<input id="search-templates-inp" type="search" placeholder="'+lumisejs._i67+'" value="'+encodeURIComponent(i.q)+'" /></h3>','<ul data-view="items">'];i.categories_full&&i.categories_full.map((function(t){s.push('<li data-id="'+t.id+'" '+(t.id==i.category?'class="active"':"")+' data-lv="'+(t.lv?t.lv:0)+'">'+"&mdash;".repeat(t.lv)+" "+t.name+"</li>")})),i.items&&i.items.length>0?(i.items.map((function(t){a.push('<li data-id="'+t.id+'"'+(u.current_design==t.id?' data-current="true"':"")+'>\t\t\t\t\t\t\t<span data-view="thumbn" data-start="'+lumisejs._i58+'">\t\t\t\t\t\t\t\t<img src="'+t.screenshot+'" />\t\t\t\t\t\t\t</span>\t\t\t\t\t\t\t<span data-view="name">'+t.name+"</span>\t\t\t\t\t\t</li>")})),i.index+i.limit<i.total&&a.push('<li data-loadmore="'+(i.index+i.limit)+'">\t\t\t\t\t\t\t<span>'+lumisejs._i68+"</span>\t\t\t\t\t\t</li>")):a.push('<li data-view="noitem" data-category="'+i.category+'">'+lumisejs._i42+"</li>"),0==i.index?(u.designs=i.items,s.push("</ul>"),a.push("</ul>"),t("#lumise-lightbox-content").html('<div id="lumise-list-items-wrp"></div>'),t("#lumise-list-items-wrp").html(s.join("")).append(a.join(""))):(u.designs=u.designs.concat(i.items),t('#lumise-lightbox-content ul[data-view="items"] li[data-loadmore]').remove(),a[0]="",a[1]="",t('#lumise-lightbox-content ul[data-view="items"]').append(a.join(""))),e({el:t("#lumise-list-items-wrp"),events:{'ul[data-view="categories"] li':"category",'ul[data-view="items"] li':"design",'h3[data-view="top"] input:keyup':"search","li[data-loadmore]":"load_more"},category:function(e){n({category:this.getAttribute("data-id"),index:0,q:t("#search-templates-inp").val()}),e.preventDefault()},design:function(e){if(null!==this.getAttribute("data-loadmore"))return e.data.load_more(e);var i=this.getAttribute("data-id"),s=u.designs.filter((function(t){return t.id==i}));t(this).closest("#lumise-lightbox").remove(),t("body").css({overflow:""}),d(s[0])},load_more:function(e){this.innerHTML='<i class="lumise-spinner x3"></i>',this.style.background="transparent",t(this).off("click"),n({category:this.getAttribute("data-category"),index:this.getAttribute("data-loadmore"),q:t("#search-templates-inp").val()})},search:function(t){void 0!==t.keyCode&&13===t.keyCode&&n({q:this.value})}})},l=function(s){if("string"==typeof s.stages)var a=JSON.parse(decodeURIComponent(atob(s.stages)));else a=s.stages;var l,d={},u="",r="",c="",m="",p=void 0!==s.color&&null!==s.color?s.color.split(":")[0]:"";"object"!=typeof a&&(a={}),void 0!==a.colors&&(p=a.colors.active,delete a.colors),Object.keys(a).length>0&&(Object.keys(a).map((function(t,e){d=a[t],null!==(m=void 0!==lumisejs.current_design&&void 0!==lumisejs.current_design[t]?lumisejs.current_design[t]:null)&&(m.scr='<img src="'+m.screenshot+'" height="'+m.offset.natural_height+'" width="'+m.offset.natural_width+'" class="lumise-design-view" style="'+m.css+'" />'),l="raws"==d.source?lumisejs.assets_url+"raws/"+d.url:lumisejs.upload_url+d.url,r+="<li"+(0==e?' class="active"':"")+'><a href="#lumise-tab-'+t+'">'+(d.label?d.label:lumisejs["_"+t])+"</a></li>",c+='<div class="lumise_tab_content'+(0==e?" active":"")+'" id="lumise-tab-'+t+'" data-stage="'+t+'">\t\t\t\t\t\t\t\t<div class="lumise-stage-settings lumise-product-design" id="lumise-product-design-'+t+'">\t\t\t\t\t\t\t\t\t<div class="lumise-stage-body">\t\t\t\t\t\t\t\t\t\t<div class="lumise-stage-design-view">\t\t\t\t\t\t\t\t\t\t\t<img style="background:'+p+'" src="'+l+'" width="'+d.product_width+'" height="'+d.product_height+'" class="lumise-stage-image" />\t\t\t\t\t\t\t\t\t\t\t<div class="lumise-stage-editzone" style="margin-left: '+d.edit_zone.left+"px;margin-top: "+d.edit_zone.top+"px;width: "+d.edit_zone.width+"px;height: "+d.edit_zone.height+"px;border-color: "+function(t){var e,i,s;if(void 0!==t&&t.indexOf("rgb")>-1)t=t.split(","),e=parseInt(t[0].trim()),i=parseInt(t[1].trim()),s=parseInt(t[2].trim());else if(void 0!==t){t.length<6&&(t+=t.replace("#",""));var a="#"==t.charAt(0)?t.substring(1,7):t.substring(0,6);e=parseInt(a.substring(0,2),16)/255*.213,i=parseInt(a.substring(2,4),16)/255*.715,s=parseInt(a.substring(4,6),16)/255*.072}return e+i+s<.5?"#DDD":"#333"}(p)+";border-radius:"+d.edit_zone.radius+'px">\t\t\t\t\t\t\t\t\t\t\t\t<div class="design-template-inner" data-id="'+(null!==m?m.id:"")+'" style="border-radius:'+d.edit_zone.radius+'px">'+(null!==m?m.scr:"")+'</div>\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t<div class="lumise-stage-btn">\t\t\t\t\t\t\t\t\t\t\t<button class="button button-primary" data-func="select-design">\t\t\t\t\t\t\t\t\t\t\t\t<i class="dashicons dashicons-art"></i>\t\t\t\t\t\t\t\t\t\t\t\t'+lumisejs._i58+'\t\t\t\t\t\t\t\t\t\t\t</button> &nbsp; \t\t\t\t\t\t\t\t\t\t\t<button class="button button-link-delete'+(null===m?" hidden":"")+'" data-func="clear-design" title="'+lumisejs._i69+'">\t\t\t\t\t\t\t\t\t\t\t\t<i class="dashicons dashicons-trash"></i>\t\t\t\t\t\t\t\t\t\t\t\t'+lumisejs._i70+'\t\t\t\t\t\t\t\t\t\t\t</button> &nbsp; \t\t\t\t\t\t\t\t\t\t\t<button class="button'+(null===m?" hidden":"")+'" data-func="download-design" title="'+lumisejs._i73+'">\t\t\t\t\t\t\t\t\t\t\t\t<i class="dashicons dashicons-arrow-down-alt"></i>\t\t\t\t\t\t\t\t\t\t\t\t'+lumisejs._i72+'\t\t\t\t\t\t\t\t\t\t\t</button>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t<div class="editzone-ranges'+(null!==m?"":" hidden")+'">\t\t\t\t\t\t\t\t\t\t\t<div class="edr-row design-scale" style="">\t\t\t\t\t\t\t\t\t\t\t\t<label>Design scale:</label>\t\t\t\t\t\t\t\t\t\t\t\t<input type="range" min="10" max="200" value="'+(null!==m?m.scale:"")+'">\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>'})),u='<div class="lumise_tabs_wrapper" id="lumise-stages-wrp" data-id="stages">'+(r='<ul class="lumise_tab_nav">\t\t\t\t\t\t<span data-view="product-name">\t\t\t\t\t\t\t<a title="'+s.name+'" href="'+lumisejs.admin_url+"&lumise-page=product&id="+s.id+'&callback=edit-base-product" data-func="edit-base-product" class="button" title="'+lumisejs._i61+'">\t\t\t\t\t\t\t\t<i class="dashicons dashicons-edit"></i> \t\t\t\t\t\t\t\t'+lumisejs._i61+"\t\t\t\t\t\t\t</a>\t\t\t\t\t\t</span>"+r+"</ul>")+'\t\t\t\t\t\t\t<div class="lumise_tabs">'+c+"</div>\t\t\t\t\t\t</div>"),t("#lumise-product-base").html(u).addClass("set-product"),e({el:t("#lumise-product-base"),events:{'button[data-func="select-design"]':"select_design",'button[data-func="clear-design"]':"delete_design",'button[data-func="download-design"]':"download_design",'a[data-func="edit-base-product"]':"edit_product",'a[data-func="remove-base-product"]':"delete_product","ul.lumise_tab_nav li a":"tab",'.editzone-ranges .design-scale input[type="range"]:input':"design_scale"},select_design:function(t){n({category:"",index:0,s:""}),t.preventDefault()},delete_design:function(e){t(this).addClass("hidden").parent().find('button[data-func="download-design"]').addClass("hidden").closest(".lumise-stage-body").find(".lumise-stage-editzone .design-template-inner").html("").attr({"data-id":""}).closest(".lumise-stage-body").find(".editzone-ranges").addClass("hidden"),o(),e.preventDefault()},download_design:function(e){var i=document.createElement("canvas"),s=document.createElement("canvas"),a=t(this).closest(".lumise-stage-body").find("img.lumise-stage-image").get(0),l=t(this).closest(".lumise-stage-body").find("img.lumise-design-view").get(0),d=t(this).closest(".lumise-stage-body").find(".lumise-stage-editzone").get(0),n=i.getContext("2d"),o=s.getContext("2d"),u=a.width/a.naturalWidth;i.width=a.naturalWidth,i.height=a.naturalHeight,s.width=d.offsetWidth/u,s.height=d.offsetHeight/u,n.fillStyle=a.style.backgroundColor,n.fillRect(0,0,i.width,i.height),o.drawImage(l,l.offsetLeft/u,l.offsetTop/u,l.width/u,l.height/u);var r=parseFloat(d.style.marginTop.replace("px",""))/u,c=parseFloat(d.style.marginLeft.replace("px",""))/u,m=c+=i.width/2-s.width/2,p=r+=i.height/2-s.height/2,h=s.width,g=s.height,f=parseInt(d.style.borderRadius.replace("px",""));n.save(),n.beginPath(),n.moveTo(m+f,p),n.lineTo(m+h-f,p),n.quadraticCurveTo(m+h,p,m+h,p+f),n.lineTo(m+h,p+g-f),n.quadraticCurveTo(m+h,p+g,m+h-f,p+g),n.lineTo(m+f,p+g),n.quadraticCurveTo(m,p+g,m,p+g-f),n.lineTo(m,p+f),n.quadraticCurveTo(m,p,m+f,p),n.closePath(),n.clip(),n.drawImage(s,m,p,h,g),n.restore(),n.drawImage(a,0,0);for(var v=i.toDataURL("image/jpeg",1).split(","),_=atob(v[1]),b=_.length,w=new Uint8Array(b),y=0;y<b;y++)w[y]=_.charCodeAt(y);var j=new Blob([w],{type:v[0].substring(v[0].indexOf("image/"),v[0].indexOf(";")-1)}),x=document.createElement("a");x.download=t('#lumise-stages-wrp [data-func="edit-base-product"]').attr("title")+".jpg",x.href=URL.createObjectURL(j),x.click(),URL.revokeObjectURL(x.href),delete x,delete j,delete i,delete s,e.preventDefault()},edit_product:function(t){i({content:'<iframe src="'+this.getAttribute("href")+'"></iframe>',class:"full-width"}),t.preventDefault()},delete_product:function(e){t("#lumise_product_base, #lumise_design_template").val(""),t("#lumise-product-base").html("").removeClass("set-product"),e.preventDefault()},tab:function(e){var i=t(this).closest("div#lumise-stages-wrp");i.find("div.lumise_tab_content.active, ul.lumise_tab_nav li.active").removeClass("active"),t(this).parent().addClass("active"),i.find(this.getAttribute("href")).addClass("active"),e.preventDefault()},design_scale:function(e){var i=t(this).closest(".lumise-stage-body").find(".design-template-inner img");if(0!==i.length){var s=i.get(0),a=s.naturalWidth,l=s.naturalHeight,d=s.offsetLeft+s.offsetWidth/2,n=s.offsetTop+s.offsetHeight/2;i.css({width:a*this.value/100+"px",height:l*this.value/100+"px",left:d-a*this.value/100/2+"px",top:n-l*this.value/100/2+"px"})}}}),t("body").css({overflow:""}),t("#lumise_product_base").val(s.id),t('#lumise-enable-customize, #lumise_product_data a[data-func="remove-base-product"]').removeClass("hidden")},d=function(e,i){var s=t(void 0!==i?'#lumise-product-base .lumise_tabs .lumise_tab_content[data-stage="'+i+'"]':"#lumise-product-base .lumise_tabs .lumise_tab_content.active");if(0!==s.length){var a=new Image;a.src=e.screenshot,a.className="lumise-design-view",s.find('.lumise-stage-btn button[data-func="clear-design"],.lumise-stage-btn button[data-func="download-design"]').removeClass("hidden"),s.find(".design-template-inner").css({"border-radius":s.find(".lumise-stage-editzone").css("border-radius")}).attr({"data-id":e.id}).html("").append(a),a.onload=function(){this.width>this.parentNode.offsetWidth&&(this.width=this.parentNode.offsetWidth,this.height=this.parentNode.offsetWidth*(this.naturalHeight/this.naturalWidth)),this.style.left=this.parentNode.offsetWidth/2-this.width/2+"px",this.style.top=this.parentNode.offsetHeight/2-this.height/2+"px";var e=t(this).closest(".lumise-stage-body").find(".editzone-ranges");e.removeClass("hidden"),e.find("input").val(this.width/this.naturalWidth*100).trigger("input")}}},n=function(e){void 0!==e.index&&0!==e.index||i({content:'<center><i class="lumise-spinner x3"></i></center>'}),t.ajax({url:lumisejs.admin_ajax_url,method:"POST",data:{nonce:"LUMISE-SECURITY-BACKEND:"+lumisejs.nonce_backend,ajax:"backend",action:"templates",category:void 0!==e.category?e.category:"",q:void 0!==e.q?e.q:"",index:void 0!==e.index?e.index:0},statusCode:{403:function(){alert("Error 403")}},success:a})},o=function(){if(""!==t("#lumise_product_base").val()){var e={};t("#lumise_product_data .lumise_tabs .lumise_tab_content").each((function(){var i=t(this),s=i.find(".design-template-inner img").get(0);i.css({display:"inline-block"}),void 0!==s&&(e[this.getAttribute("data-stage")]={id:i.find(".design-template-inner").data("id"),scale:i.find(".design-scale input").val(),css:i.find(".design-template-inner img").attr("style"),offset:{top:s.offsetTop,left:s.offsetLeft,width:s.offsetWidth,height:s.offsetHeight,natural_width:s.naturalWidth,natural_height:s.naturalHeight},screenshot:i.find(".design-template-inner img").attr("src")}),i.css({display:""})})),lumisejs.current_design=e,t("#lumise_design_template").val(encodeURIComponent(JSON.stringify(e)))}else t("#lumise_design_template").val("")},u={designs:[]};window.lumise_reset_products=function(e){delete u.products,t("#lumise-lightbox").remove(),t("#lumise_product_base").val(e.id),o(),l(e)},e({el:t("#lumise_product_data"),events:{'a[data-func="products"]':"products",'a[data-func="remove-base-product"]':"remove_product","#lumise-product-base:mousedown":"start_drag"},products:function(e){if(e.preventDefault(),i({content:'<center><i class="lumise-spinner x3"></i></center>'}),void 0!==u.products)return s(u.products);t.ajax({url:lumisejs.admin_ajax_url,method:"POST",data:{nonce:"LUMISE-SECURITY-BACKEND:"+lumisejs.nonce_backend,action:"list_products",task:"cms_product"},statusCode:{403:function(){alert("Error 403")}},success:function(t){void 0===u.products&&(u.products=t),s(u.products)}})},remove_product:function(e){t('#lumise-enable-customize, #lumise_product_data a[data-func="remove-base-product"]').addClass("hidden"),t("#lumise-product-base").html('<p class="notice notice-warning">'+lumisejs._i71+"</p>"),t("#lumise_product_base, #lumise_design_template").val(""),t("html,body").animate({scrollTop:t("#lumise_product_data").offset().top-100}),e.preventDefault()},start_drag:function(e){if("IMG"==e.target.tagName&&"lumise-design-view"==e.target.className){var i=t(e.target),s=e.clientX,a=e.clientY,l=e.target.offsetLeft,d=e.target.offsetTop,n=e.target.offsetWidth,o=e.target.offsetHeight;t(document).on("mousemove",(function(t){var e=i.parent().width();ph=i.parent().height(),new_left=l+(t.clientX-s),new_top=d+(t.clientY-a),new_left<.85*-n&&(new_left=.85*-n),new_top<.85*-o&&(new_top=.85*-o),new_left>e-.15*n&&(new_left=e-.15*n),new_top>ph-.15*o&&(new_top=ph-.15*o),i.css({left:new_left+"px",top:new_top+"px"})})),t(document).on("mouseup",(function(){t(document).off("mousemove mouseup")})),e.preventDefault()}}}),t("#lumise_product_data").closest("form").on("submit",o),t("#product-type").on("change",(function(e){"simple"==this.value?(t("ul.product_data_tabs li.lumise_options.lumise_tab").show(),t("ul.product_data_tabs li.lumise_options.lumise_tab a").trigger("click")):t("ul.product_data_tabs li.lumise_options.lumise_tab").hide()})).change(),void 0!==window.lumisejs.current_data?l(lumisejs.current_data):(t("#lumise-product-base").html('<p class="notice notice-warning">'+lumisejs._i71+"</p>"),t('#lumise-enable-customize, #lumise_product_data a[data-func="remove-base-product"]').addClass("hidden"))}));